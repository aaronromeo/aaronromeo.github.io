<!DOCTYPE html>
<html lang="en">
    <head>
            <meta charset="utf-8" />
            <title>&gt;&nbsp;aaronromeo.com</title>
            <link rel="stylesheet" href="/theme/css/main.css" />

            <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
            <![endif]-->
    </head>

    <body>
        <header>
            <cover-section>
                <site-name>
                &gt;&nbsp;aaronromeo.com
                </site-name>
            </cover-section>
            <nav-section>
                <ul>
                    <li><a href="/index.html">Home</a></li>
                    <li><a href="/category/django.html">Django</a></li>
                    <li><a href="/category/rails.html">Rails</a></li>
                </ul>
            </nav-section>
        </header>
        <main-section>
            <blog-owner>
<ul>
    <li><img src="/theme/images/avatar.png"></li>
    <!-- <li><author-name>Aaron Romeo</author-name></li> -->
</ul>            </blog-owner>
            <articles>
<h2>Articles in the Rails category</h2>
<h2><a href="/jest-snapshots-with-webpacker.html">Jest Snapshot testing within Rails Webpacker</a></h2>
<h4><p>Jest snapshot within Rails Webpacker</p></h4>
<article-contents>
    <h3>Preable</h3>
<p>Ah... The state of the Rails ecosystem couldn't be better for me. With the supplementing of the asset pipeline with <a href="https://github.com/rails/webpacker">Webpacker</a> the world of Javascript development has joined nicely with the world of Rails development.
If you are like me and using ReactJS as your staple JS view layer, you probably know of the testing tool <a href="https://facebook.github.io/jest/">Jest</a> also created by the smart people at Facebook. This short tutorial assumes you have Webpacker and ReactJS running to to help, and you get setup with Jest.</p>
<h3>Setup</h3>
<ol>
<li>Install your packages.
<code>yarn</code> or <code>npm</code> install the following packages<ul>
<li><code>jest</code> (the main testing library)</li>
<li><code>babel-jest</code> (assuming you are using <code>babel</code>, this is the associated <code>jest</code> plugin)</li>
<li><code>babel-preset-es2015</code> (Babel preset for all es2015 plugins)</li>
<li><code>babel-preset-react</code> (Babel preset for react)</li>
<li><code>react-test-renderer</code> (another FB testing tool which renders React components to pure Javascript objects)
<code>yarn</code> does a better job of managing your JS packages, so here you go...
<code>yarn add --dev jest babel-jest babel-preset-es2015 babel-preset-react react-test-renderer</code></li>
</ul>
</li>
<li>Add the <code>.baberc</code> file to your project root.
Till this point, your project has been happily using the <code>config/webpack/loaders/react.js</code> and <code>config/webpack/loaders/babel.js</code> to translate your ES6 JS back to the stoneage. With Jest, though, it needs a little something more.
This is what my <code>.babelrc</code> file looks like. Yours will be similar, but your <code>plugins</code> will be dependent on what you have installed in your <code>react.js</code> or <code>babel.js</code> files.
    <code>{
      "presets": [
        "es2015",
        "react",
      ],
      "env": {
        "test": {
          "plugins": [
            "transform-function-bind",
            "transform-class-properties"
          ]
        }
      }
    }</code></li>
<li>Modify the <code>package.json</code> to include the Jest config. Here is what my diff looked like.
    ```
       "scripts": {
         "eslint": "eslint --ext .jsx --ext .js app/javascript/**"<ul>
<li>},</li>
<li>"jest": {</li>
<li>"roots": [</li>
<li>"app/javascript"</li>
<li>],</li>
<li>"moduleDirectories": [</li>
<li>"<rootDir>/node_modules"</li>
<li>],</li>
<li>"moduleFileExtensions": [</li>
<li>"js",</li>
<li>"jsx"</li>
<li>]
   }
 }
```</li>
</ul>
</li>
</ol>
<h3>An example</h3>
<p>Say you have the files in your project to define the component <code>BlogExample</code>
* app/javascript/components/blog_example/index.js
    ```javascript
    import BlogExample from './blog_example'</p>
<div class="highlight"><pre><span class="n">export</span> <span class="k">default</span> <span class="n">BlogExample</span>
<span class="err">```</span>
</pre></div>


<ul>
<li>
<p>app/javascript/components/blog_example/blog_example.js
    ```javascript
    import PropTypes from 'prop-types'
    import React, { Component } from 'react'</p>
<p>class BlogExample extends Component {
  static propTypes = {
    contacts: PropTypes.arrayOf(
      PropTypes.shape({
        email: PropTypes.string,
        id: PropTypes.string.isRequired,
      }).isRequired
    ).isRequired,
    handleDeleteContact: PropTypes.func.isRequired,
  }</p>
<p>constructor(props) {
    super(props)
    this.renderContacts = this.renderContacts.bind(this)
  }</p>
<p>renderContacts() {
    return this.props.contacts.map(contact =&gt; (
      <li key={contact.id}>
       <a href="#" onClick={() => this.props.handleDeleteContact(contact)}&gt;{contact.email}</a>
      </li>
    ))
  }</p>
<p>render() {
    return (
      <div>
        { this.renderContacts() }
      </div>
    )
  }
}</p>
<p>export default BlogExample
<code>You could then create the following base test case
* app/javascript/components/blog_example/\__tests__/blog_example.spec.jsx</code>javascript
import React from 'react'
import renderer from 'react-test-renderer'
import BlogExample from '../index'</p>
<p>test('Renders contacts', () =&gt; {
  const component = renderer.create(
    <BlogExample
      contacts={[{
          email: 'jane@example.com',
          id: '1',
        }, {
          email: 'joe@example.com',
          id: '2',
        }]}
      handleDeleteContact={() => {}}
    /&gt;
  )
  const tree = component.toJSON()
  expect(tree).toMatchSnapshot()
})
<code>``
If you run this with</code>bin/yarn jest`, you should see the following output generated</p>
</li>
</ul>
<div class="highlight"><pre> <span class="n">PASS</span>  <span class="n">app</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">blog_example</span><span class="o">/</span><span class="n">__tests__</span><span class="o">/</span><span class="n">blog_example</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">jsx</span>
  <span class="err">✓</span> <span class="n">Null</span> <span class="n">Contacts</span> <span class="p">(</span><span class="mi">12</span><span class="n">ms</span><span class="p">)</span>

 <span class="err">›</span> <span class="mi">1</span> <span class="n">snapshot</span> <span class="n">written</span><span class="p">.</span>
<span class="n">Snapshot</span> <span class="n">Summary</span>
 <span class="err">›</span> <span class="mi">1</span> <span class="n">snapshot</span> <span class="n">written</span> <span class="n">in</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">suite</span><span class="p">.</span>

<span class="n">Test</span> <span class="n">Suites</span><span class="o">:</span> <span class="mi">1</span> <span class="n">passed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">total</span>
<span class="nl">Tests:</span>       <span class="mi">1</span> <span class="n">passed</span><span class="p">,</span> <span class="mi">1</span> <span class="n">total</span>
<span class="nl">Snapshots:</span>   <span class="mi">1</span> <span class="n">added</span><span class="p">,</span> <span class="mi">1</span> <span class="n">total</span>
<span class="nl">Time:</span>        <span class="mf">1.054</span><span class="n">s</span>
</pre></div>


<p>After you have run this, you should see the file <code>app/javascript/components/blog_example/__tests__/__snapshots__/blog_example.spec.jsx.snap</code> also created.</p>
<p>Say you modify your code base with a change, for example</p>
<div class="highlight"><pre><span class="gh">diff --git a/app/javascript/components/blog_example/blog_example.js b/app/javascript/components/blog_example/blog_example.js</span>
<span class="gh">index 1717dab..72bfa39 100644</span>
<span class="gd">--- a/app/javascript/components/blog_example/blog_example.js</span>
<span class="gi">+++ b/app/javascript/components/blog_example/blog_example.js</span>
<span class="gu">@@ -20,7 +20,7 @@ class BlogExample extends Component {</span>
   renderContacts() {
     return this.props.contacts.map(contact =&gt; (
       &lt;li key={contact.id}&gt;
<span class="gd">-       &lt;a href=&quot;#&quot; onClick={() =&gt; this.props.handleDeleteContact(contact)}&gt;{contact.email}&lt;/a&gt;</span>
<span class="gi">+        &lt;a href=&quot;#&quot; onClick={() =&gt; this.props.handleDeleteContact(contact)}&gt;* {contact.email}&lt;/a&gt;</span>
       &lt;/li&gt;
     ))
   }
</pre></div>


<p>This will result in a failing test when you run <code>bin/yarn jest</code></p>
<div class="highlight"><pre><span class="nx">yarn</span> <span class="nb">run</span> <span class="nx">v1.3.2</span>
<span class="nx">warning</span> <span class="nx">package.json</span><span class="p">:</span> <span class="nx">No</span> <span class="nx">license</span> <span class="nb">field</span>
<span class="err">$</span> <span class="p">/</span><span class="nx">Users</span><span class="p">/</span><span class="nx">aromeo</span><span class="p">/</span><span class="nx">workspace</span><span class="p">/</span><span class="nx">addresser</span><span class="p">/</span><span class="nx">node_modules</span><span class="p">/</span><span class="nx">.bin</span><span class="p">/</span><span class="nx">jest</span> <span class="nx">app</span><span class="p">/</span><span class="nb">javascript</span><span class="p">/</span><span class="nb">components</span><span class="p">/</span><span class="nx">blog_example</span>
 <span class="nb">FAIL</span>  <span class="nx">app</span><span class="p">/</span><span class="nb">javascript</span><span class="p">/</span><span class="nb">components</span><span class="p">/</span><span class="nx">blog_example</span><span class="p">/</span><span class="nx">__tests__</span><span class="p">/</span><span class="nx">blog_example.spec.jsx</span>
  <span class="err">✕</span> <span class="nx">Renders</span> <span class="nx">contacts</span> <span class="p">(</span><span class="mi">19</span><span class="nx">ms</span><span class="p">)</span>

  <span class="err">●</span> <span class="nx">Renders</span> <span class="nx">contacts</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nb">value</span><span class="p">)</span><span class="bp">.</span><span class="nx">toMatchSnapshot</span><span class="p">()</span>

    <span class="nx">Received</span> <span class="nb">value</span> <span class="nx">does</span> <span class="ow">not</span> <span class="k">match</span> <span class="nx">stored</span> <span class="nx">snapshot</span> <span class="mi">1</span><span class="nx">.</span>

    <span class="o">-</span> <span class="nx">Snapshot</span>
    <span class="o">+</span> <span class="nx">Received</span>

    <span class="p">@@</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">17</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">19</span> <span class="p">@@</span>
        <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">a</span>
            <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span>
            <span class="n">onClick</span><span class="o">=</span><span class="p">{</span><span class="err">[</span><span class="nx">Function</span><span class="cp">]</span>}
          &gt;
    +       *
            jane@example.com
          <span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>
          <span class="nt">&lt;a</span>
            <span class="na">href=</span><span class="s">&quot;#&quot;</span>
            <span class="na">onClick=</span><span class="s">{</span><span class="cp">[</span><span class="nx">Function</span><span class="cp">]</span><span class="s">}</span>
          <span class="nt">&gt;</span>
    +       *
            joe@example.com
          <span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      at Object.<span class="nt">&lt;anonymous&gt;</span> (app/javascript/components/blog_example/__tests__/blog_example.spec.jsx:19:16)
          at new Promise (<span class="nt">&lt;anonymous&gt;</span>)
          at <span class="nt">&lt;anonymous&gt;</span>
      at process._tickCallback (internal/process/next_tick.js:188:7)

 › 1 snapshot test failed.
Snapshot Summary
 › 1 snapshot test failed in 1 test suite. Inspect your code changes or run with `yarn run jest -- -u` to update them.

Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 total
Snapshots:   1 failed, 1 total
Time:        1.324s
Ran all test suites matching /app\/javascript\/components\/blog_example/i.
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
</pre></div>


<p><code>bin/yarn jest -- -u</code> updates your snapshot.</p>
<h3>Gotchas</h3>
<p><code>yarn</code> doesn't verify that the version of <code>react-test-renderer</code> matches the version of <code>react</code> you have installed.</p>
<div class="highlight"><pre>         <span class="s">&quot;jest&quot;</span><span class="o">:</span> <span class="s">&quot;21.2.1&quot;</span><span class="p">,</span>
    <span class="o">-</span>    <span class="s">&quot;react-test-renderer&quot;</span><span class="o">:</span> <span class="s">&quot;16.0.0&quot;</span><span class="p">,</span>
    <span class="o">+</span>    <span class="s">&quot;react-test-renderer&quot;</span><span class="o">:</span> <span class="s">&quot;^15.5.4&quot;</span><span class="p">,</span>
         <span class="s">&quot;redux-devtools&quot;</span><span class="o">:</span> <span class="s">&quot;^3.4.0&quot;</span><span class="p">,</span>
</pre></div>


<p>If they don't match, you'll get a nasty error... Like this one I got.</p>
<div class="highlight"><pre><span class="nx">yarn</span> <span class="nb">run</span> <span class="nx">v1.3.2</span>
<span class="nx">warning</span> <span class="nx">package.json</span><span class="p">:</span> <span class="nx">No</span> <span class="nx">license</span> <span class="nb">field</span>
<span class="err">$</span> <span class="p">/</span><span class="nx">Users</span><span class="p">/</span><span class="nx">aromeo</span><span class="p">/</span><span class="nx">workspace</span><span class="p">/</span><span class="nx">addresser</span><span class="p">/</span><span class="nx">node_modules</span><span class="p">/</span><span class="nx">.bin</span><span class="p">/</span><span class="nx">jest</span> <span class="nx">app</span><span class="p">/</span><span class="nb">javascript</span><span class="p">/</span><span class="nb">components</span><span class="p">/</span><span class="nx">blog_example</span>
 <span class="nb">FAIL</span>  <span class="nx">app</span><span class="p">/</span><span class="nb">javascript</span><span class="p">/</span><span class="nb">components</span><span class="p">/</span><span class="nx">blog_example</span><span class="p">/</span><span class="nx">__tests__</span><span class="p">/</span><span class="nx">blog_example.spec.jsx</span>
  <span class="err">●</span> <span class="nx">Test</span> <span class="nx">suite</span> <span class="nx">failed</span> <span class="k">to</span> <span class="nb">run</span>

    <span class="nx">TypeError</span><span class="p">:</span> <span class="nx">Cannot</span> <span class="nb">read</span> <span class="nx">property</span> <span class="s1">&#39;ReactCurrentOwner&#39;</span> <span class="nx">of</span> <span class="nx">undefined</span>

      <span class="nx">at</span> <span class="nx">node_modules</span><span class="p">/</span><span class="nx">react</span><span class="na">-test-renderer</span><span class="p">/</span><span class="nx">cjs</span><span class="p">/</span><span class="nx">react</span><span class="na">-test-renderer.development.js</span><span class="p">:</span><span class="mi">77</span><span class="p">:</span><span class="mi">40</span>
      <span class="nx">at</span> <span class="nx">Object.</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span> <span class="p">(</span><span class="nx">node_modules</span><span class="p">/</span><span class="nx">react</span><span class="na">-test-renderer</span><span class="p">/</span><span class="nx">cjs</span><span class="p">/</span><span class="nx">react</span><span class="na">-test-renderer.development.js</span><span class="p">:</span><span class="mi">7639</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
      <span class="nx">at</span> <span class="nx">Object.</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span> <span class="p">(</span><span class="nx">node_modules</span><span class="p">/</span><span class="nx">react</span><span class="na">-test-renderer</span><span class="p">/</span><span class="nx">index.js</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>
      <span class="nx">at</span> <span class="nx">Object.</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span> <span class="p">(</span><span class="nx">app</span><span class="p">/</span><span class="nb">javascript</span><span class="p">/</span><span class="nb">components</span><span class="p">/</span><span class="nx">blog_example</span><span class="p">/</span><span class="nx">__tests__</span><span class="p">/</span><span class="nx">blog_example.spec.jsx</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">26</span><span class="p">)</span>
          <span class="nx">at</span> <span class="nx">Generator.next</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span><span class="p">)</span>
          <span class="nx">at</span> <span class="nb">new</span> <span class="nx">Promise</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span><span class="p">)</span>
          <span class="nx">at</span> <span class="nx">Generator.next</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span><span class="p">)</span>
          <span class="nx">at</span> <span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span>
      <span class="nx">at</span> <span class="nx">process._tickCallback</span> <span class="p">(</span><span class="nx">internal</span><span class="p">/</span><span class="nb">process</span><span class="p">/</span><span class="nx">next_tick.js</span><span class="p">:</span><span class="mi">188</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>

<span class="nx">Test</span> <span class="nx">Suites</span><span class="p">:</span> <span class="mi">1</span> <span class="nx">failed</span><span class="p">,</span> <span class="mi">1</span> <span class="nx">total</span>
<span class="nx">Tests</span><span class="p">:</span>       <span class="mi">0</span> <span class="nx">total</span>
<span class="nx">Snapshots</span><span class="p">:</span>   <span class="mi">0</span> <span class="nx">total</span>
<span class="nb">Time</span><span class="p">:</span>        <span class="mf">0.764</span><span class="nb">s</span><span class="p">,</span> <span class="nx">estimated</span> <span class="mi">1</span><span class="nb">s</span>
<span class="nx">Ran</span> <span class="kc">all</span> <span class="nx">test</span> <span class="nx">suites</span> <span class="nx">matching</span> <span class="p">/</span><span class="nx">app</span><span class="o">\/</span><span class="nb">javascript</span><span class="o">\/</span><span class="nb">components</span><span class="o">\/</span><span class="nx">blog_example</span><span class="p">/</span><span class="nx">i.</span>
<span class="nb">error</span> <span class="nb">Command</span> <span class="nx">failed</span> <span class="k">with</span> <span class="nx">exit</span> <span class="nb">code</span> <span class="mi">1</span><span class="nx">.</span>
<span class="nx">info</span> <span class="nx">Visit</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//yarnpkg.com/en/docs/cli/run for documentation about this command.</span>
</pre></div>
</article-contents>
    <paginator>
        Page 1 / 1
    </paginator>

        </articles>
        </main-section>
        <footer>
        </footer>
    </body>
</html>